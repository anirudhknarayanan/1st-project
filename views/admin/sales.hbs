
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">


<style>
    h2 {
        text-align: center;
    }

    .top-buttons {
        display: flex;
        justify-content: end;
        gap: 10px;
    }

    button {
        padding: 8px 12px;
        border: none;
        cursor: pointer;
        border-radius: 4px;
    }

    .pdf-btn {
        background: linear-gradient(to right, #FF8C00, #af7105);
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 5px;
        cursor: pointer;
        transition: 0.3s;

    }

    .pdf-btn:hover {
        background: linear-gradient(to right, #FF8C00, #af7105);
    }

    .excel-btn {
        background: linear-gradient(to right, #509352, #213f23);
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 5px;
        cursor: pointer;
        transition: 0.3s;
    }

    .excel-btn:hover {
        background: linear-gradient(to right, #2d562e, #285a29);
    }

    .top-buttons {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
    }

    .filter-container {
        display: flex;
        align-items: center;
        gap: 15px;
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        justify-content: center;
    }

    .filter-group {
        margin-top: -18px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .filter-select,
    .date-input {
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 16px;
        transition: 0.3s;
    }

    .filter-select:focus,
    .date-input:focus {
        outline: none;
        border-color: #FFD700;
        box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }

    .date-range {
        display: flex;
        gap: 17px;
        align-items: center;
        justify-content: center;
    }

    .btn.filter-btn {
        background: linear-gradient(to right, #000000, #689163);
        color: white;
        font-weight: bold;
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 20px;
    }

    .btn.filter-btn:hover {
        background: linear-gradient(to right, #2d562e, #285a29);
    }

    .summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .box {
        background: #f0f0f0;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
    }

    .box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* ✅ NEW: Coupon box specific styles */
    .coupon-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .admin-coupon-box {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .referral-coupon-box {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .savings-box {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }

    /* ✅ NEW: Total Offer Savings box style */
    .total-offer-savings-box {
        background: linear-gradient(135deg, #fd7e14 0%, #e55100 100%);
        color: white;
    }

    .box h4 {
        margin-top: 0;
        color: #333;
    }

    .box p {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 0;
        color: #444;
    }

    /* ✅ NEW: Small text styling for coupon boxes */
    .box small {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        opacity: 0.8;
        font-weight: normal;
    }

    /* Override text color for colored boxes */
    .coupon-box p, .admin-coupon-box p, .referral-coupon-box p, .savings-box p,
    .total-offer-savings-box p {
        color: white;
    }

    /* ✅ NEW: Coupon Analytics Table Styles */
    .coupon-analytics {
        margin-top: 30px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .coupon-analytics h3 {
        color: #333;
        margin-bottom: 20px;
        text-align: center;
        font-size: 24px;
    }

    .coupon-table-container {
        overflow-x: auto;
    }

    .coupon-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .coupon-table th {
        background: linear-gradient(135deg, #77c7c0 0%, #000000 100%);
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: bold;
    }

    .coupon-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }

    .coupon-table tr:hover {
        background-color: #f8f9fa;
    }

    .coupon-code {
        font-family: monospace;
        font-weight: bold;
        color: #2c3e50;
    }

    .coupon-type {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
    }

    .admin-type {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .referral-type {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .usage-count {
        text-align: center;
        font-weight: bold;
        color: #e74c3c;
    }

    .savings-amount {
        text-align: right;
        font-weight: bold;
        color: #27ae60;
    }

    /* ✅ NEW: Discount column styling */
    .discount-amount {
        text-align: center;
        font-weight: bold;
        color: #e74c3c;
        background-color: #f8f9fa; /* Same as th background */
    }

    /* Style discount column header */
   

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    table,
    th,
    td {
        border: 1px solid #ddd;
    }

    th,
    td {
        padding: 10px;
        text-align: left;
    }

    th {
        background: #8BCAC3;
        color: white;
    }

    tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    tr:hover {
        background-color: #f0f0f0;
    }

    .status {
        padding: 5px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
    }

    /* Existing statuses */
    .delivered {
        background-color: #7cdd93;
        /* Green */
        color: rgb(26, 70, 16);
    }

    .cancelled {
        background-color: #dc3545;
        /* Red */
        color: white;
    }

    .pending {
        background-color: #c4b178;
        /* Yellow */
        color: rgb(171, 126, 0);
    }

    /* New return statuses */
    .return-rejected {
        background-color: #e6828c;
        /* Red */
        color: rgb(150, 20, 20);
    }

    .return-approved {
        background-color: #88c16e;
        /* Blue */
        color: rgb(19, 129, 0);
    }

    /* ✅ NEW: Payment method column styling */
    .payment-method {
        text-align: center;
        font-weight: bold;
    }

    .payment-cod {
        background-color: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }

    .payment-online {
        background-color: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }

    .payment-wallet {
        background-color: #6f42c1;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }

    .payment-other, .payment-unknown {
        background-color: #6c757d;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }

    /* ✅ NEW: Offer column styling */
    .offer-applied {
        text-align: center;
        font-weight: bold;
    }

    .offer-amount {
        background-color: #493e40;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        display: block;
        margin-bottom: 2px;
    }

    .offer-type {
        font-size: 9px;
        color: #666;
        font-style: italic;
        display: block;
    }

    .offer-product {
        background-color: #6f42c1;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }

    .offer-category {
        background-color: #fd7e14;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }

    .offer-none {
        background-color: #6c757d;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination a {
        color: white;
        background-color: black;
        padding: 8px 12px;
        margin: 2px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        transition: background-color 0.3s;
    }

    .pagination a.active {
        background-color: #444;
    }

    .pagination a:hover {
        background-color: #666;
    }

    .no-results {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #777;
    }

    .filter-active {
        background-color: #8BCAC3;
        border: 2px #000000;
        padding: 8px;
        margin-bottom: 10px;
        text-align: center;
        border-radius: 10px;
    }
</style>


<div class="container">
    <h2>Sales Report</h2>

    <div class="top-buttons">
        <a
            href="/admin/salesReportPDF/pdf{{#if filterType}}?filterType={{filterType}}{{/if}}{{#if fromDate}}&fromDate={{fromDate}}{{/if}}{{#if toDate}}&toDate={{toDate}}{{/if}}">
            <button class="pdf-btn">Download PDF</button>
        </a>
        <a
            href="/admin/salesReportExcel/excel{{#if filterType}}?filterType={{filterType}}{{/if}}{{#if fromDate}}&fromDate={{fromDate}}{{/if}}{{#if toDate}}&toDate={{toDate}}{{/if}}">
            <button class="excel-btn">Download Excel</button>
        </a>
    </div>

    <form id="filterForm" action="/admin/salesReport" method="GET" class="filter-container">
        <div class="filter-group">
            <label for="filterType">Filter By:</label>
            <select name="filterType" id="filterType" class="filter-select">
                <option value="All" {{#ifEquals filterType "All" }}selected{{/ifEquals}}>All Time</option>
                <option value="Daily" {{#ifEquals filterType "Daily" }}selected{{/ifEquals}}>Daily</option>
                <option value="Weekly" {{#ifEquals filterType "Weekly" }}selected{{/ifEquals}}>Weekly</option>
                <option value="Monthly" {{#ifEquals filterType "Monthly" }}selected{{/ifEquals}}>Monthly</option>
                <option value="Yearly" {{#ifEquals filterType "Yearly" }}selected{{/ifEquals}}>Yearly</option>
                <option value="Custom" {{#if (or (eq filterType "Custom" ) (and (not filterType) (not fromDate) (not
                    toDate)))}}selected{{/if}}>Custom Range</option>
            </select>
        </div>

        <div id="dateRangeFields" class="date-range"
            style="{{#if (or fromDate toDate filterTypeCustom)}}display: flex;{{else}}display: none;{{/if}}">
            <div class="filter-group">
                <label for="fromDate">From:</label>
                <input type="date" name="fromDate" id="fromDate" value="{{fromDate}}" class="date-input">
            </div>

            <div class="filter-group">
                <label for="toDate">To:</label>
                <input type="date" name="toDate" id="toDate" value="{{toDate}}" class="date-input">
            </div>
        </div>

        <button type="submit" class="btn filter-btn">Apply Filter</button>
    </form>

    {{#if filterType}}
    <div class="filter-active">
        <strong>Active Filter:</strong>
        {{#ifEquals filterType "Daily"}}Today
        {{else ifEquals filterType "Weekly"}}This Week (From Sunday)
        {{else ifEquals filterType "Monthly"}}Current Month
        {{else ifEquals filterType "Yearly"}}Current Year
        {{else if (and fromDate toDate)}}
        Custom: {{formatDate fromDate}} to {{formatDate toDate}}
        {{else}}
        {{filterType}}
        {{/ifEquals}}
    </div>
    {{/if}}

    <div class="summary">
        <div class="box">
            <h4>Overall Sales Count</h4>
            <p>{{{totalOrders}}}</p>
        </div>
        <div class="box">
            <h4>Overall Sales Amount</h4>
            <p>₹{{formatNumber totalSales}}.00</p>
        </div>
       
        <!-- ✅ NEW: Coupon Usage Analytics -->
        <div class="box coupon-box">
            <h4>Total Coupons Used</h4>
            <p>{{totalCouponsUsed}}</p>
            <small>All coupon types</small>
        </div>
        <div class="box admin-coupon-box">
            <h4>Admin Coupons</h4>
            <p>{{adminCouponsUsed}}</p>
            <small>Regular discount coupons</small>
        </div>
        <div class="box referral-coupon-box">
            <h4>Referral Coupons</h4>
            <p>{{referralCouponsUsed}}</p>
            <small>Referral rewards used</small>
        </div>
        <div class="box savings-box">
            <h4>Total Savings Given</h4>
            <p>₹{{formatNumber totalAllCouponSavings}}.00</p>
            <small>Through all coupons</small>
        </div>

         <!-- ✅ NEW: Total Offer Savings -->
        <div class="box total-offer-savings-box">
            <h4>Total Offer Savings</h4>
            <p>₹{{formatNumber totalOfferSavingsAllOrders}}.00</p>
            <small>Product & category offers</small>
        </div>
    </div>

    {{#if orders.length}}
    <table>
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Date</th>
                <th>Customer Name</th>
                <th>Product</th>
                <th>Order Status</th>
                <th>Payment Method</th>
                <th>Offer Applied</th>
                <th>Discount</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            {{#each orders}}
            <tr>
                <td>#{{this.orderId}}</td>
                <td>{{formatDate this.createdAt}}</td>
                <td>{{this.user_id.name}}</td>
                <td>
                    {{#each this.order_items}}
                    {{this.productId.productName}}{{#unless @last}}, {{/unless}}
                    {{/each}}
                </td>
                <td class="status {{dashCase this.status}}">
                    {{this.status}}
                </td>
                <td class="payment-method">
                    {{#if this.payment_method}}
                        {{#if (eq this.payment_method "cod")}}
                            <span class="payment-cod">COD</span>
                        {{else if (eq this.payment_method "razorpay")}}
                            <span class="payment-online">Razorpay</span>
                        {{else if (eq this.payment_method "wallet")}}
                            <span class="payment-wallet">Wallet</span>
                        {{else}}
                            <span class="payment-other">{{this.payment_method}}</span>
                        {{/if}}
                    {{else}}
                        <span class="payment-unknown">Unknown</span>
                    {{/if}}
                </td>
                <td class="offer-applied">
                    {{#if this.offerSavings}}
                        {{#if (gt this.offerSavings 0)}}
                            <span class="offer-amount">₹{{formatNumberFixed this.offerSavings}} Off</span>
                            <small class="offer-type">Product/Category Offer</small>
                        {{else if this.discount}}
                            {{#if (gt this.discount 0)}}
                                <span class="offer-amount">₹{{formatNumberFixed this.discount}} Off</span>
                                <small class="offer-type">Coupon Discount</small>
                            {{else}}
                                <span class="offer-none">No Offer</span>
                            {{/if}}
                        {{else}}
                            <span class="offer-none">No Offer</span>
                        {{/if}}
                    {{else if this.discount}}
                        {{#if (gt this.discount 0)}}
                            <span class="offer-amount">₹{{formatNumberFixed this.discount}} Off</span>
                            <small class="offer-type">Coupon Discount</small>
                        {{else}}
                            <span class="offer-none">No Offer</span>
                        {{/if}}
                    {{else}}
                        <span class="offer-none">No Offer</span>
                    {{/if}}
                </td>
                <td class="discount-amount">
                    {{#if this.discount}}
                        ₹{{formatNumberFixed this.discount}}
                    {{else}}
                        ₹0
                    {{/if}}
                </td>
                <td>₹ {{#if this.finalAmount}}{{formatNumberFixed this.finalAmount}}{{else}}{{formatNumberFixed
                    this.total}}{{/if}}</td>
            </tr>
            {{/each}}
        </tbody>
    </table>

    <div class="pagination">
        {{#if (gt currentPage 1)}}
        <a
            href="?page={{subtract currentPage 1}}{{#if filterType}}&filterType={{filterType}}{{/if}}{{#if fromDate}}&fromDate={{fromDate}}{{/if}}{{#if toDate}}&toDate={{toDate}}{{/if}}">&laquo;
            Prev</a>
        {{/if}}

        {{#each (range 1 totalPages)}}
        <a href="?page={{this}}{{#if ../filterType}}&filterType={{../filterType}}{{/if}}{{#if ../fromDate}}&fromDate={{../fromDate}}{{/if}}{{#if ../toDate}}&toDate={{../toDate}}{{/if}}"
            class="{{#ifEquals this ../currentPage}}active{{/ifEquals}}">{{this}}</a>
        {{/each}}

        {{#if (lt currentPage totalPages)}}
        <a
            href="?page={{add currentPage 1}}{{#if filterType}}&filterType={{filterType}}{{/if}}{{#if fromDate}}&fromDate={{fromDate}}{{/if}}{{#if toDate}}&toDate={{toDate}}{{/if}}">Next
            &raquo;</a>
        {{/if}}
    </div>
    {{else}}
    <div class="no-results">
        <p>No sales data found for the selected period.</p>
    </div>
    {{/if}}
</div>



    <!-- ✅ NEW: Top Used Coupons Section -->
    {{#if topCoupons}}
    <div class="coupon-analytics">
        <h3>Top Used Coupons</h3>
        <div class="coupon-table-container">
            <table class="coupon-table">
                <thead>
                    <tr>
                        <th>Coupon Code</th>
                        <th>Type</th>
                        <th>Usage Count</th>
                        <th>Total Savings</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each topCoupons}}
                    <tr>
                        <td class="coupon-code">{{this.code}}</td>
                        <td>
                            <span class="coupon-type {{#ifEquals this.type 'Admin Coupon'}}admin-type{{else}}referral-type{{/ifEquals}}">
                                {{this.type}}
                            </span>
                        </td>
                        <td class="usage-count">{{this.usageCount}}</td>
                        <td class="savings-amount">₹{{formatNumber this.totalSavings}}</td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
    {{/if}}

<script>document.addEventListener('DOMContentLoaded', function () {
        const filterType = document.getElementById('filterType');
        const dateRangeFields = document.getElementById('dateRangeFields');
        const fromDate = document.getElementById('fromDate');
        const toDate = document.getElementById('toDate');

        // Get today's date in YYYY-MM-DD format
        const today = new Date().toISOString().split('T')[0];

        // Set max date for both fromDate and toDate to today (prevent future dates)
        fromDate.setAttribute('max', today);
        toDate.setAttribute('max', today);

        // Show/hide date fields based on filter type
        filterType.addEventListener('change', function () {
            if (this.value === 'Custom') {
                dateRangeFields.style.display = 'flex';
                fromDate.required = true;
                toDate.required = true;
            } else {
                dateRangeFields.style.display = 'none';
                fromDate.required = false;
                toDate.required = false;

                // Clear date values when switching to a preset filter
                fromDate.value = '';
                toDate.value = '';
                // Reset toDate min attribute when clearing but keep max
                toDate.removeAttribute('min');
                toDate.setAttribute('max', today);
            }
        });

        // Set minimum date for toDate based on fromDate selection
        fromDate.addEventListener('change', function () {
            const selectedFromDate = this.value;
            if (selectedFromDate) {
                // Set the minimum date for toDate to be the selected fromDate
                // and maximum date to today
                toDate.setAttribute('min', selectedFromDate);
                toDate.setAttribute('max', today);
                
                // If toDate is already selected and is before the new fromDate, clear it
                if (toDate.value && toDate.value < selectedFromDate) {
                    toDate.value = '';
                    alert('To date has been cleared as it was before the selected from date. Please select a new to date.');
                }
                
                // If toDate is already selected and is after today, clear it
                if (toDate.value && toDate.value > today) {
                    toDate.value = '';
                    alert('To date has been cleared as future dates are not allowed. Please select a valid to date.');
                }
            } else {
                // Remove min attribute if fromDate is cleared but keep max
                toDate.removeAttribute('min');
                toDate.setAttribute('max', today);
            }
        });

        // Initialize min date for toDate if fromDate already has a value (for page reload scenarios)
        if (fromDate.value) {
            toDate.setAttribute('min', fromDate.value);
            toDate.setAttribute('max', today);
        }

        // Form validation
        document.getElementById('filterForm').addEventListener('submit', function (e) {
            if (filterType.value === 'Custom') {
                if (!fromDate.value || !toDate.value) {
                    e.preventDefault();
                    alert('Please select both start and end dates for custom range');
                } else if (new Date(fromDate.value) > new Date(toDate.value)) {
                    e.preventDefault();
                    alert('Start date cannot be after end date');
                } else if (new Date(fromDate.value) > new Date(today) || new Date(toDate.value) > new Date(today)) {
                    e.preventDefault();
                    alert('Future dates are not allowed. Please select valid dates.');
                }
            }
        });
    });
</script>

